{"version":3,"file":"add.js","sources":["pages/wx/photos/add.vue","../../soft/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvd3gvcGhvdG9zL2FkZC52dWU"],"sourcesContent":["<template>\n  <view class=\"add-photos\">\n    <view class=\"nav\">\n      <text class=\"back\" @tap=\"goBack\">‹</text>\n      <view class=\"center\">\n        <text class=\"title\">新增照片</text>\n        <text class=\"count\">{{ photos.length }}/9</text>\n      </view>\n      <text class=\"done\" :class=\"{ active: canSubmit }\" @tap=\"handleSubmit\">完成</text>\n    </view>\n\n    <view class=\"tip\">\n      <image class=\"tip-icon\" src=\"https://img.icons8.com/fluency/48/camera.png\" mode=\"aspectFit\" />\n      <text class=\"tip-text\">最多选择 9 张，支持预览与删除</text>\n    </view>\n\n    <!-- 文案输入（可选） -->\n    <view class=\"desc-card\">\n      <textarea class=\"desc-input\" v-model=\"overallCaption\" placeholder=\"为这组照片写一句话...（可选）\" maxlength=\"120\" />\n    </view>\n\n    <!-- 工具栏 -->\n    <view class=\"toolbar\">\n      <view class=\"tb-btn\" @tap=\"chooseFromAlbum\">\n        <image class=\"tb-ic\" src=\"https://img.icons8.com/fluency/32/gallery.png\" mode=\"aspectFit\" />\n        <text class=\"tb-txt\">从相册</text>\n      </view>\n      <view class=\"tb-btn\" @tap=\"takePhoto\">\n        <image class=\"tb-ic\" src=\"https://img.icons8.com/fluency/32/camera.png\" mode=\"aspectFit\" />\n        <text class=\"tb-txt\">拍摄</text>\n      </view>\n      <view class=\"tb-btn ghost\" @tap=\"clearAll\" v-if=\"photos.length\">\n        <image class=\"tb-ic\" src=\"https://img.icons8.com/fluency/32/trash.png\" mode=\"aspectFit\" />\n        <text class=\"tb-txt\">清空</text>\n      </view>\n    </view>\n\n    <!-- 上传设置 -->\n    <view class=\"cfg-card\">\n      <view class=\"cfg-row\">\n        <text class=\"cfg-label\">压缩上传</text>\n        <switch :checked=\"enableCompress\" @change=\"onToggleCompress\" />\n      </view>\n      <view class=\"cfg-row\" v-if=\"enableCompress\">\n        <text class=\"cfg-label\">质量</text>\n        <slider class=\"cfg-slider\" min=\"40\" max=\"100\" step=\"10\" :value=\"quality\" @change=\"onQualityChange\" />\n        <text class=\"cfg-val\">{{ quality }}</text>\n      </view>\n    </view>\n\n    <view class=\"grid\">\n      <view class=\"cell\" v-for=\"(p,i) in photos\" :key=\"i\">\n        <image :class=\"['img', { loaded: loadedMap[i] }]\" :src=\"p.url\" mode=\"aspectFill\" @tap=\"preview(i)\" @load=\"onImgLoad(i)\" />\n        <view class=\"del\" @tap=\"remove(i)\">✕</view>\n        <input class=\"cap\" v-model=\"p.caption\" placeholder=\"添加说明（可选）\" maxlength=\"40\" />\n      </view>\n      <view v-if=\"photos.length < 9\" class=\"add\" @tap=\"choose\">\n        <text class=\"plus\">+</text>\n        <text class=\"txt\">添加</text>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed } from 'vue'\n\nconst photos = ref([])\nconst canSubmit = computed(()=> photos.value.length > 0)\nconst loadedMap = ref({})\nconst enableCompress = ref(true)\nconst quality = ref(80)\nconst overallCaption = ref('')\n\nconst goBack = () => uni.navigateBack({ delta: 1 })\n\nconst choose = () => {\n  uni.chooseImage({\n    count: 9 - photos.value.length,\n    success: async (res) => {\n      const paths = (res.tempFiles && res.tempFiles.length) ? res.tempFiles.map(f=>f.path || f.tempFilePath || f) : (res.tempFilePaths || [])\n      if (!paths.length) return\n      uni.showLoading({ title: '上传中...' })\n      try {\n        const tasks = paths.map(path => new Promise((resolve, reject) => {\n          const doUpload = (finalPath) => {\n            uniCloud.uploadFile({\n              filePath: finalPath,\n              cloudPath: `wx-photos/${Date.now()}-${Math.random().toString(36).slice(-6)}${String(finalPath).match(/\\.[^.]+$/)}`,\n              success: (r) => resolve({ url: r.fileID, caption: '' }),\n              fail: reject\n            })\n          }\n          if (enableCompress.value) {\n            uni.compressImage({\n              src: path,\n              quality: quality.value,\n              success: (cr) => doUpload(cr.tempFilePath || cr.tempFiles?.[0]?.tempFilePath || path),\n              fail: () => doUpload(path)\n            })\n          } else {\n            doUpload(path)\n          }\n        }))\n        const list = await Promise.all(tasks)\n        photos.value.push(...list)\n      } catch (e) {\n        uni.showToast({ title: e.message || '上传失败', icon: 'none' })\n      } finally {\n        uni.hideLoading()\n      }\n    }\n  })\n}\n\nconst chooseFromAlbum = () => choose()\nconst takePhoto = () => {\n  uni.chooseImage({\n    count: 1,\n    sourceType: ['camera'],\n    success: (r) => {\n      // 复用上传流程\n      const res = { tempFilePaths: r.tempFilePaths, tempFiles: r.tempFiles }\n      // @ts-ignore\n      choose.call(null, res)\n    }\n  })\n}\nconst clearAll = () => { photos.value = [] }\nconst onToggleCompress = (e) => { enableCompress.value = !!(e?.detail?.value) }\nconst onQualityChange = (e) => { quality.value = Number(e?.detail?.value || quality.value) }\n\nconst preview = (idx) => {\n  const urls = photos.value.map(p=>p.url)\n  uni.previewImage({ urls, current: urls[idx] })\n}\n\nconst remove = (idx) => { photos.value.splice(idx, 1) }\n\nconst onImgLoad = (i) => { loadedMap.value[i] = true }\n\nconst handleSubmit = async () => {\n  if (!canSubmit.value) return\n  uni.showLoading({ title: '提交中...' })\n  try {\n    // 使用与 wx_add_moment 一致的新增接口\n    const payload = {\n      content: overallCaption.value || '',\n      mediaList: photos.value.map(p => ({ type: 'image', url: p.url, caption: p.caption || '' })),\n      location: '',\n      privacy: 'public'\n    }\n    const { result } = await uniCloud.callFunction({ name: 'wx_add_moment', data: payload })\n    if (!result || result.code !== 0) {\n      throw new Error(result?.msg || '提交失败')\n    }\n    // 提交成功后回传到上一页并返回\n    try { uni.$emit('photosAdded', photos.value) } catch (_) {}\n    uni.showToast({ title: '已添加', icon: 'success' })\n    setTimeout(()=>{ goBack() }, 600)\n  } catch (e) {\n    uni.showToast({ title: e.message || '提交失败', icon: 'none' })\n  } finally {\n    uni.hideLoading()\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n$primary-gradient: linear-gradient(90deg, #bec3cc 0%, #b2a8d4 100%);\n.add-photos { \n  min-height: 100vh; \n  background: linear-gradient(180deg, #f7f9ff 0%, #f4f6fd 100%);\n  position: relative;\n}\n.add-photos::before {\n  content: '';\n  position: fixed;\n  inset: 0;\n  background:\n    radial-gradient(60% 60% at 15% 20%, rgba(90,143,255,0.06) 0%, rgba(90,143,255,0) 70%),\n    radial-gradient(50% 50% at 85% 80%, rgba(127,90,255,0.06) 0%, rgba(127,90,255,0) 70%);\n  pointer-events: none;\n  z-index: 0;\n}\n.nav { display: flex; align-items: center; justify-content: space-between; padding: 20rpx 16rpx; background: $primary-gradient; color: #fff; position: sticky; top: 0; z-index: 10; box-shadow: 0 6rpx 18rpx rgba(90,143,255,0.25); }\n.back { font-size: 44rpx; width: 64rpx; text-align: center; }\n.center { display: flex; align-items: baseline; gap: 10rpx; }\n.title { font-size: 32rpx; font-weight: 700; }\n.count { font-size: 24rpx; opacity: 0.9; background: rgba(255,255,255,0.18); border: 1rpx solid rgba(255,255,255,0.35); padding: 4rpx 10rpx; border-radius: 999rpx; }\n.done { font-size: 28rpx; opacity: 0.7; }\n.done.active { opacity: 1; font-weight: 700; }\n.tip { margin: 24rpx; padding: 18rpx; background: #fff; border-radius: 16rpx; color: #41506b; font-size: 24rpx; border: 1rpx solid rgba(0,0,0,0.04); display: flex; align-items: center; gap: 10rpx; box-shadow: 0 8rpx 24rpx rgba(0,0,0,0.06); }\n.tip-icon { width: 40rpx; height: 40rpx; }\n.tip-text { font-size: 26rpx; }\n.grid { margin: 24rpx; display: grid; grid-template-columns: repeat(3, 1fr); gap: 14rpx; }\n.cell { position: relative; border-radius: 16rpx; overflow: hidden; background: #fff; border: 1rpx solid rgba(0,0,0,0.04); box-shadow: 0 6rpx 18rpx rgba(0,0,0,0.05); }\n.img { width: 100%; height: 220rpx; object-fit: cover; display: block; transform: scale(1.01); opacity: 0; transition: opacity 0.35s ease, transform 0.35s ease; }\n.img.loaded { opacity: 1; transform: scale(1); }\n.del { position: absolute; right: 6rpx; top: 6rpx; width: 40rpx; height: 40rpx; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); color: #fff; font-weight: 700; }\n.cap { position: absolute; left: 8rpx; right: 8rpx; bottom: 8rpx; height: 60rpx; border-radius: 12rpx; background: rgba(255,255,255,0.92); border: 1rpx solid #e5e9f3; padding: 0 12rpx; font-size: 24rpx; }\n.add { height: 220rpx; border-radius: 14rpx; border: 2rpx dashed #dbe3ff; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #5A8FFF; background: #fff; transition: transform 0.2s ease, background 0.2s ease; box-shadow: 0 6rpx 18rpx rgba(0,0,0,0.04); }\n.add:active { transform: scale(0.98); background: #f5f8ff; }\n.plus { font-size: 56rpx; line-height: 1; }\n.txt { font-size: 24rpx; }\n\n.desc-card { margin: 0 24rpx 12rpx 24rpx; background: #fff; border-radius: 16rpx; border: 1rpx solid #eef1f7; box-shadow: 0 6rpx 18rpx rgba(0,0,0,0.04); }\n.desc-input { min-height: 100rpx; padding: 16rpx 18rpx; font-size: 26rpx; line-height: 1.6; }\n\n.toolbar { margin: 0 24rpx 8rpx 24rpx; display: flex; gap: 12rpx; }\n.tb-btn { flex: none; display: inline-flex; align-items: center; gap: 8rpx; padding: 12rpx 16rpx; border-radius: 999rpx; background: rgba(90,143,255,0.08); border: 1rpx solid rgba(90,143,255,0.28); color: #5A8FFF; }\n.tb-btn.ghost { background: #fff; color: #8b97ad; border-color: #e7eaf2; }\n.tb-ic { width: 32rpx; height: 32rpx; }\n.tb-txt { font-size: 24rpx; }\n\n.cfg-card { margin: 0 24rpx 8rpx 24rpx; background: #fff; border-radius: 16rpx; border: 1rpx solid #eef1f7; box-shadow: 0 6rpx 18rpx rgba(0,0,0,0.04); }\n.cfg-row { display: flex; align-items: center; justify-content: space-between; padding: 16rpx 18rpx; }\n.cfg-label { font-size: 26rpx; color: #41506b; }\n.cfg-slider { flex: 1; margin: 0 12rpx; }\n.cfg-val { width: 80rpx; text-align: right; font-size: 24rpx; color: #6b7280; }\n</style>\n","import MiniProgramPage from 'D:/WORKPLACE/uu-company/pages/wx/photos/add.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","computed","uni","uniCloud"],"mappings":"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"}