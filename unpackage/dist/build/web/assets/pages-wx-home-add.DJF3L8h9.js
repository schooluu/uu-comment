import{r as a,R as e,e as l,w as s,m as t,c,f as u,h as n,k as i,i as o,j as r,F as d,z as m,v as p,E as f,G as v,Y as _,s as h,ae as g,H as y,B as k,a5 as w,af as b,l as x,K as C,p as F,q as I,X as P}from"./index-0EbhcMDI.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=$({__name:"add",setup($){const j=a(""),L=a([]),V=a(""),D=a("public"),E=a([]),M=e((()=>({public:"公开",friends:"仅好友可见",private:"仅自己可见"}[D.value]))),q=e((()=>j.value.trim()||L.value.length>0)),z=()=>{f()},B=async()=>{if(q.value)try{v({title:"发布中..."});const{result:a}=await _.callFunction({name:"wx_add_moment",data:{content:j.value,mediaList:L.value,location:V.value,privacy:D.value}});if(0!==a.code)throw new Error(a.msg);h({title:"发布成功",icon:"success"}),g("refreshMoments"),setTimeout((()=>{f()}),1500)}catch(a){h({title:a.message||"发布失败",icon:"none"})}finally{y()}},G=()=>{k({itemList:["拍摄","从相册选择"],success:a=>{0===a.tapIndex||w({count:9-L.value.length,success:async a=>{v({title:"上传中..."});try{const e=await(async a=>{console.log("uploadImages",a[0]);try{const e=a.map((a=>new Promise(((e,l)=>{_.uploadFile({filePath:a,cloudPath:`wx-moments/${Date.now()}-${Math.random().toString(36).slice(-6)}${a.match(/\.[^.]+$/)}`,success:a=>{e({type:"image",url:a.fileID})},fail:l})}))));return await Promise.all(e)}catch(e){return console.error(e),h({title:e.message||"图片上传失败",icon:"none"}),[]}})(a.tempFilePaths);L.value.push(...e)}finally{y()}}})}})},H=()=>{k({itemList:["公开","仅好友可见","仅自己可见"],success:a=>{D.value=["public","friends","private"][a.tapIndex]}})},K=()=>{b({success:a=>{V.value=a.name}})};return(a,e)=>{const f=x,v=t,_=C,h=I,g=P;return c(),l(v,{class:"publish-container"},{default:s((()=>[u(v,{class:"nav-bar"},{default:s((()=>[u(f,{class:"cancel",onClick:z},{default:s((()=>[n("取消")])),_:1}),u(f,{class:i(["publish",{active:q.value}]),onClick:B},{default:s((()=>[n("发表")])),_:1},8,["class"])])),_:1}),u(v,{class:"content-area"},{default:s((()=>[u(_,{class:"content-input",modelValue:j.value,"onUpdate:modelValue":e[0]||(e[0]=a=>j.value=a),placeholder:"这一刻的想法...","placeholder-style":"color: #999;",maxlength:"1000","auto-height":""},null,8,["modelValue"])])),_:1}),u(v,{class:"media-area"},{default:s((()=>[u(v,{class:"media-grid"},{default:s((()=>[(c(!0),o(d,null,r(L.value,((a,e)=>(c(),l(v,{key:e,class:"media-item"},{default:s((()=>["image"===a.type?(c(),l(h,{key:0,src:a.url,mode:"aspectFill",onClick:a=>(a=>{const e=L.value.filter((a=>"image"===a.type)).map((a=>a.url));F({urls:e,current:e[a]})})(e)},null,8,["src","onClick"])):"video"===a.type?(c(),l(g,{key:1,src:a.url,class:"video-preview"},null,8,["src"])):m("",!0),u(v,{class:"delete-btn",onClick:a=>(a=>{L.value.splice(a,1)})(e)},{default:s((()=>[n("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128)),L.value.length<9?(c(),l(v,{key:0,class:"add-btn",onClick:G},{default:s((()=>[u(f,{class:"iconfont"},{default:s((()=>[n("+")])),_:1})])),_:1})):m("",!0)])),_:1})])),_:1}),u(v,{class:"bottom-options"},{default:s((()=>[u(v,{class:"option-item",onClick:H},{default:s((()=>[u(f,null,{default:s((()=>[n("谁可以看")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(M.value),1)])),_:1})])),_:1}),u(v,{class:"option-item",onClick:K},{default:s((()=>[u(f,null,{default:s((()=>[n("所在位置")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(V.value||"添加位置"),1)])),_:1})])),_:1}),u(v,{class:"option-item"},{default:s((()=>[u(f,null,{default:s((()=>[n("提醒谁看")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(E.value.length?`已选${E.value.length}人`:"添加"),1)])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-1aa514c0"]]);export{j as default};
