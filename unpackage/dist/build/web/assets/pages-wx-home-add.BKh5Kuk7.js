import{r as a,O as e,e as l,w as s,x as t,c,f as u,h as n,k as i,i as o,j as r,A as d,F as m,t as p,G as f,H as v,l as _,s as h,a5 as y,J as g,D as k,a1 as w,q as b,a6 as x,v as C,L as F,y as I,U as P}from"./index-6mcuTnYd.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";const L=$({__name:"add",setup($){const L=a(""),j=a([]),D=a(""),V=a("public"),M=a([]),U=e((()=>({public:"公开",friends:"仅好友可见",private:"仅自己可见"}[V.value]))),q=e((()=>L.value.trim()||j.value.length>0)),A=()=>{f()},E=async()=>{if(q.value)try{v({title:"发布中..."});const{result:a}=await _.callFunction({name:"wx_add_moment",data:{content:L.value,mediaList:j.value,location:D.value,privacy:V.value}});if(0!==a.code)throw new Error(a.msg);h({title:"发布成功",icon:"success"}),y("refreshMoments"),setTimeout((()=>{f()}),1500)}catch(a){h({title:a.message||"发布失败",icon:"none"})}finally{g()}},G=()=>{k({itemList:["拍摄","从相册选择"],success:a=>{0===a.tapIndex||w({count:9-j.value.length,success:async a=>{v({title:"上传中..."});try{const e=await(async a=>{console.log("uploadImages",a[0]);try{const e=a.map((a=>new Promise(((e,l)=>{_.uploadFile({filePath:a,cloudPath:`wx-moments/${Date.now()}-${Math.random().toString(36).slice(-6)}${a.match(/\.[^.]+$/)}`,success:a=>{e({type:"image",url:a.fileID})},fail:l})}))));return await Promise.all(e)}catch(e){return console.error(e),h({title:e.message||"图片上传失败",icon:"none"}),[]}})(a.tempFilePaths);j.value.push(...e)}finally{g()}}})}})},H=()=>{k({itemList:["公开","仅好友可见","仅自己可见"],success:a=>{V.value=["public","friends","private"][a.tapIndex]}})},J=()=>{x({success:a=>{D.value=a.name}})};return(a,e)=>{const f=C,v=t,_=F,h=I,y=P;return c(),l(v,{class:"publish-container"},{default:s((()=>[u(v,{class:"nav-bar"},{default:s((()=>[u(f,{class:"cancel",onClick:A},{default:s((()=>[n("取消")])),_:1}),u(f,{class:i(["publish",{active:q.value}]),onClick:E},{default:s((()=>[n("发表")])),_:1},8,["class"])])),_:1}),u(v,{class:"content-area"},{default:s((()=>[u(_,{class:"content-input",modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=a=>L.value=a),placeholder:"这一刻的想法...","placeholder-style":"color: #999;",maxlength:"1000","auto-height":""},null,8,["modelValue"])])),_:1}),u(v,{class:"media-area"},{default:s((()=>[u(v,{class:"media-grid"},{default:s((()=>[(c(!0),o(m,null,r(j.value,((a,e)=>(c(),l(v,{key:e,class:"media-item"},{default:s((()=>["image"===a.type?(c(),l(h,{key:0,src:a.url,mode:"aspectFill",onClick:a=>(a=>{const e=j.value.filter((a=>"image"===a.type)).map((a=>a.url));b({urls:e,current:e[a]})})(e)},null,8,["src","onClick"])):"video"===a.type?(c(),l(y,{key:1,src:a.url,class:"video-preview"},null,8,["src"])):d("",!0),u(v,{class:"delete-btn",onClick:a=>(a=>{j.value.splice(a,1)})(e)},{default:s((()=>[n("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128)),j.value.length<9?(c(),l(v,{key:0,class:"add-btn",onClick:G},{default:s((()=>[u(f,{class:"iconfont"},{default:s((()=>[n("+")])),_:1})])),_:1})):d("",!0)])),_:1})])),_:1}),u(v,{class:"bottom-options"},{default:s((()=>[u(v,{class:"option-item",onClick:H},{default:s((()=>[u(f,null,{default:s((()=>[n("谁可以看")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(U.value),1)])),_:1})])),_:1}),u(v,{class:"option-item",onClick:J},{default:s((()=>[u(f,null,{default:s((()=>[n("所在位置")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(D.value||"添加位置"),1)])),_:1})])),_:1}),u(v,{class:"option-item"},{default:s((()=>[u(f,null,{default:s((()=>[n("提醒谁看")])),_:1}),u(f,{class:"value"},{default:s((()=>[n(p(M.value.length?`已选${M.value.length}人`:"添加"),1)])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-1aa514c0"]]);export{L as default};
