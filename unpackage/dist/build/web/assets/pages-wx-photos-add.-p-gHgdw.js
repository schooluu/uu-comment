import{r as a,O as l,e,w as s,x as t,c,f as u,h as n,t as o,k as i,A as d,i as r,j as p,F as m,G as f,a1 as v,H as h,l as g,s as _,J as y,q as F,a7 as b,v as k,y as x,L as C,a8 as w,a9 as P,I as V}from"./index-CZm5vXxk.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";const L=I({__name:"add",setup(I){const L=a([]),$=l((()=>L.value.length>0)),j=a({}),U=a(!0),q=a(80),A=a(""),D=()=>f({delta:1}),S=()=>{v({count:9-L.value.length,success:async a=>{const l=a.tempFiles&&a.tempFiles.length?a.tempFiles.map((a=>a.path||a.tempFilePath||a)):a.tempFilePaths||[];if(l.length){h({title:"上传中..."});try{const a=l.map((a=>new Promise(((l,e)=>{const s=a=>{g.uploadFile({filePath:a,cloudPath:`wx-photos/${Date.now()}-${Math.random().toString(36).slice(-6)}${String(a).match(/\.[^.]+$/)}`,success:a=>l({url:a.fileID,caption:""}),fail:e})};U.value?uni.compressImage({src:a,quality:q.value,success:l=>{var e,t;return s(l.tempFilePath||(null==(t=null==(e=l.tempFiles)?void 0:e[0])?void 0:t.tempFilePath)||a)},fail:()=>s(a)}):s(a)})))),e=await Promise.all(a);L.value.push(...e)}catch(e){_({title:e.message||"上传失败",icon:"none"})}finally{y()}}}})},T=()=>S(),E=()=>{v({count:1,sourceType:["camera"],success:a=>{const l={tempFilePaths:a.tempFilePaths,tempFiles:a.tempFiles};S.call(null,l)}})},G=()=>{L.value=[]},H=a=>{var l;U.value=!!(null==(l=null==a?void 0:a.detail)?void 0:l.value)},J=a=>{var l;q.value=Number((null==(l=null==a?void 0:a.detail)?void 0:l.value)||q.value)},M=async()=>{if($.value){h({title:"提交中..."});try{const l={content:A.value||"",mediaList:L.value.map((a=>({type:"image",url:a.url,caption:a.caption||""}))),location:"",privacy:"public"},{result:e}=await g.callFunction({name:"wx_add_moment",data:l});if(!e||0!==e.code)throw new Error((null==e?void 0:e.msg)||"提交失败");try{b("photosAdded",L.value)}catch(a){}_({title:"已添加",icon:"success"}),setTimeout((()=>{D()}),600)}catch(l){_({title:l.message||"提交失败",icon:"none"})}finally{y()}}};return(a,l)=>{const f=k,v=t,h=x,g=C,_=w,y=P,b=V;return c(),e(v,{class:"add-photos"},{default:s((()=>[u(v,{class:"nav"},{default:s((()=>[u(f,{class:"back",onClick:D},{default:s((()=>[n("‹")])),_:1}),u(v,{class:"center"},{default:s((()=>[u(f,{class:"title"},{default:s((()=>[n("新增照片")])),_:1}),u(f,{class:"count"},{default:s((()=>[n(o(L.value.length)+"/9",1)])),_:1})])),_:1}),u(f,{class:i(["done",{active:$.value}]),onClick:M},{default:s((()=>[n("完成")])),_:1},8,["class"])])),_:1}),u(v,{class:"tip"},{default:s((()=>[u(h,{class:"tip-icon",src:"https://img.icons8.com/fluency/48/camera.png",mode:"aspectFit"}),u(f,{class:"tip-text"},{default:s((()=>[n("最多选择 9 张，支持预览与删除")])),_:1})])),_:1}),u(v,{class:"desc-card"},{default:s((()=>[u(g,{class:"desc-input",modelValue:A.value,"onUpdate:modelValue":l[0]||(l[0]=a=>A.value=a),placeholder:"为这组照片写一句话...（可选）",maxlength:"120"},null,8,["modelValue"])])),_:1}),u(v,{class:"toolbar"},{default:s((()=>[u(v,{class:"tb-btn",onClick:T},{default:s((()=>[u(h,{class:"tb-ic",src:"https://img.icons8.com/fluency/32/gallery.png",mode:"aspectFit"}),u(f,{class:"tb-txt"},{default:s((()=>[n("从相册")])),_:1})])),_:1}),u(v,{class:"tb-btn",onClick:E},{default:s((()=>[u(h,{class:"tb-ic",src:"https://img.icons8.com/fluency/32/camera.png",mode:"aspectFit"}),u(f,{class:"tb-txt"},{default:s((()=>[n("拍摄")])),_:1})])),_:1}),L.value.length?(c(),e(v,{key:0,class:"tb-btn ghost",onClick:G},{default:s((()=>[u(h,{class:"tb-ic",src:"https://img.icons8.com/fluency/32/trash.png",mode:"aspectFit"}),u(f,{class:"tb-txt"},{default:s((()=>[n("清空")])),_:1})])),_:1})):d("",!0)])),_:1}),u(v,{class:"cfg-card"},{default:s((()=>[u(v,{class:"cfg-row"},{default:s((()=>[u(f,{class:"cfg-label"},{default:s((()=>[n("压缩上传")])),_:1}),u(_,{checked:U.value,onChange:H},null,8,["checked"])])),_:1}),U.value?(c(),e(v,{key:0,class:"cfg-row"},{default:s((()=>[u(f,{class:"cfg-label"},{default:s((()=>[n("质量")])),_:1}),u(y,{class:"cfg-slider",min:"40",max:"100",step:"10",value:q.value,onChange:J},null,8,["value"]),u(f,{class:"cfg-val"},{default:s((()=>[n(o(q.value),1)])),_:1})])),_:1})):d("",!0)])),_:1}),u(v,{class:"grid"},{default:s((()=>[(c(!0),r(m,null,p(L.value,((a,l)=>(c(),e(v,{class:"cell",key:l},{default:s((()=>[u(h,{class:i(["img",{loaded:j.value[l]}]),src:a.url,mode:"aspectFill",onClick:a=>(a=>{const l=L.value.map((a=>a.url));F({urls:l,current:l[a]})})(l),onLoad:a=>(a=>{j.value[a]=!0})(l)},null,8,["class","src","onClick","onLoad"]),u(v,{class:"del",onClick:a=>{return e=l,void L.value.splice(e,1);var e}},{default:s((()=>[n("✕")])),_:2},1032,["onClick"]),u(b,{class:"cap",modelValue:a.caption,"onUpdate:modelValue":l=>a.caption=l,placeholder:"添加说明（可选）",maxlength:"40"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)))),128)),L.value.length<9?(c(),e(v,{key:0,class:"add",onClick:S},{default:s((()=>[u(f,{class:"plus"},{default:s((()=>[n("+")])),_:1}),u(f,{class:"txt"},{default:s((()=>[n("添加")])),_:1})])),_:1})):d("",!0)])),_:1})])),_:1})}}},[["__scopeId","data-v-998ae304"]]);export{L as default};
