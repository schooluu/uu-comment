import{r as e,e as a,w as l,l as s,s as t,a4 as n,x as c,c as o,f as i,h as u,i as m,j as d,t as r,k as f,F as _,A as v,B as p,m as k,y as g,v as y,U as h,I as w,z as b,S as x}from"./index-BIoudiLZ.js";import{a as C,o as j}from"./uni-app.es.CYkKyQcB.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const L="https://img0.baidu.com/it/u=1415523915,841919565&fm=253&app=120&size=w931&n=0&f=JPEG&fmt=auto?sec=1713286800&t=a9e21a0e5650a672fa2cbd3b133ed7e0",E=F({__name:"index",setup(F){const E=e(!1),T=e(!1),U=e(""),I=e(-1),z=e({}),P=e(1),V=e(10),S=e(!1),A=e(!0),B=e([]),D=()=>{k({url:"/pages/wx/login/login"})},G=async(e=!1)=>{if(!S.value&&(A.value||e))try{S.value=!0;const a=new Promise((e=>setTimeout(e,800))),[{result:l}]=await Promise.all([s.callFunction({name:"wx_get_list",data:{page:e?1:P.value,pageSize:V.value}}),a]);if(0!==l.code)throw new Error(l.msg);e?(B.value=l.data.list,P.value=1):(B.value=[...B.value,...l.data.list],P.value++),A.value=l.data.hasMore}catch(a){t({title:a.message||"获取朋友圈失败",icon:"none"})}finally{S.value=!1,e&&n()}};C((()=>{G(!0)})),j((()=>{G()}));const J=async()=>{if(U.value.trim())try{const{result:e}=await s.callFunction({name:"wx_add_comment",data:{momentId:B.value[I.value]._id,content:U.value}});if(0!==e.code)throw new Error(e.msg);{const e=B.value[I.value];e.comments||(e.comments=[]),e.comments.push({username:"我",content:U.value,create_time:Date.now()}),U.value="",E.value=!1,T.value=!1,t({title:"评论成功",icon:"success"})}}catch(e){t({title:e.message||"评论失败",icon:"none"})}},M=async()=>{k({url:"/pages/wx/home/add"})},O=()=>{E.value=!1,T.value=!1,U.value="",I.value=-1},$=()=>{T.value=!T.value},q=()=>{t({title:"视频加载失败",icon:"none"})},H=["😊","😂","🤣","❤️","😍","🤔","😒","👍","👎","😳","🥺","😭","😘","🤗","🙄","😴","🤮","🤧","😷","🤒","🤕","😈","👻","👽","🤖","💩","😺","💪","👊","✌️","🤞","🙏","👏","🙌","👐","🤲"];return(e,n)=>{const k=g,C=y,j=c,F=h,P=w,V=b,A=x;return o(),a(j,{class:"moments-container"},{default:l((()=>[i(j,{class:"header",onClick:D},{default:l((()=>[i(k,{class:"bg-image",src:L,mode:"aspectFill"}),i(j,{class:"avatar-area"},{default:l((()=>[i(j,{class:"user-info"},{default:l((()=>[i(C,{class:"nickname"},{default:l((()=>[u("未登入")])),_:1}),i(k,{class:"avatar",src:L,mode:"aspectFill"})])),_:1})])),_:1})])),_:1}),i(j,{class:"moments-list"},{default:l((()=>[(o(!0),m(_,null,d(B.value,((e,n)=>(o(),a(j,{class:"moment-item",key:n},{default:l((()=>[i(k,{class:"user-avatar",src:e.avatar,mode:"aspectFill"},null,8,["src"]),i(j,{class:"content-area"},{default:l((()=>[i(j,{class:"username"},{default:l((()=>[u(r(e.username),1)])),_:2},1024),i(C,{class:"text-content"},{default:l((()=>[u(r(e.content),1)])),_:2},1024),e.mediaType?(o(),a(j,{key:0,class:"media-content"},{default:l((()=>["video"===e.mediaType?(o(),a(F,{key:0,src:e.mediaUrl,poster:e.poster,class:"video-content",controls:"","show-center-play-btn":"","enable-play-gesture":"","show-fullscreen-btn":"","show-play-btn":"","object-fit":"contain",onError:q},null,8,["src","poster"])):"image"===e.mediaType?(o(),a(j,{key:1,class:f(["image-gallery",`columns-${e.mediaUrls.length}`])},{default:l((()=>[(o(!0),m(_,null,d(e.mediaUrls,((e,l)=>(o(),a(k,{key:l,src:e,mode:"aspectFill",class:"image-content"},null,8,["src"])))),128))])),_:2},1032,["class"])):v("",!0)])),_:2},1024)):v("",!0),i(j,{class:"bottom-info"},{default:l((()=>[i(C,{class:"time"},{default:l((()=>[u(r(e.time),1)])),_:2},1024),i(j,{class:"actions"},{default:l((()=>[i(j,{class:f(["action-btn like-btn",{liked:e.isLiked,animating:z.value[n]}]),onClick:e=>(async e=>{try{const a=B.value[e];z.value[e]=!0;const{result:l}=await s.callFunction({name:"wx_add_toggle_like",data:{momentId:a._id}});if(0!==l.code)throw new Error(l.msg);if(a.isLiked=l.data.isLiked,a.isLiked)a.likes||(a.likes=[]),a.likes.push("我");else{const e=a.likes.indexOf("我");e>-1&&a.likes.splice(e,1)}setTimeout((()=>{z.value[e]=!1}),1e3)}catch(a){t({title:a.message||"操作失败",icon:"none"})}})(n)},{default:l((()=>[i(C,{class:"icon"},{default:l((()=>[u(r(e.isLiked?"❤️":"🤍"),1)])),_:2},1024),i(C,{class:"action-text"},{default:l((()=>[u(r(e.isLiked?"已赞":"点赞"),1)])),_:2},1024)])),_:2},1032,["class","onClick"]),i(j,{class:"action-btn comment-btn",onClick:e=>(e=>{I.value=e,E.value=!0})(n)},{default:l((()=>[i(C,{class:"icon"},{default:l((()=>[u("💬")])),_:1}),i(C,{class:"action-text"},{default:l((()=>[u("评论")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),e.likes&&e.likes.length?(o(),a(j,{key:1,class:"likes-section"},{default:l((()=>[i(C,{class:"like-users"},{default:l((()=>[u(r(e.likes.join("、")),1)])),_:2},1024)])),_:2},1024)):v("",!0),e.comments&&0!==e.comments.length?(o(),a(j,{key:2,class:"comments-section"},{default:l((()=>[(o(!0),m(_,null,d(e.comments,((e,s)=>(o(),a(j,{class:"comment-item",key:s},{default:l((()=>[i(C,{class:"comment-user"},{default:l((()=>[u(r(e.username)+"：",1)])),_:2},1024),i(C,{class:"comment-content"},{default:l((()=>[u(r(e.content),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):v("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),E.value?(o(),a(j,{key:0,class:"comment-popup",onClick:O},{default:l((()=>[i(j,{class:"comment-box",onClick:n[1]||(n[1]=p((()=>{}),["stop"]))},{default:l((()=>[i(j,{class:"comment-input-area"},{default:l((()=>[i(P,{class:"comment-input",modelValue:U.value,"onUpdate:modelValue":n[0]||(n[0]=e=>U.value=e),placeholder:"评论",focus:E.value,onConfirm:J},null,8,["modelValue","focus"]),i(j,{class:"toolbar"},{default:l((()=>[i(C,{class:"emoji-btn",onClick:$},{default:l((()=>[u("😊")])),_:1}),i(V,{class:f(["submit-btn",{active:U.value.trim()}]),onClick:J},{default:l((()=>[u("发送")])),_:1},8,["class"])])),_:1})])),_:1}),T.value?(o(),a(j,{key:0,class:"emoji-panel"},{default:l((()=>[i(A,{"scroll-y":"",class:"emoji-list"},{default:l((()=>[i(j,{class:"emoji-group"},{default:l((()=>[(o(),m(_,null,d(H,((e,a)=>i(C,{key:a,class:"emoji-item",onClick:a=>(e=>{U.value+=e})(e)},{default:l((()=>[u(r(e),1)])),_:2},1032,["onClick"]))),64))])),_:1})])),_:1})])),_:1})):v("",!0)])),_:1})])),_:1})):v("",!0),i(j,{class:"publish-btn",onClick:M},{default:l((()=>[i(j,{class:"icon-wrapper"},{default:l((()=>[i(C,{class:"iconfont"},{default:l((()=>[u("+")])),_:1})])),_:1})])),_:1}),S.value?(o(),a(j,{key:1,class:"loading-container"},{default:l((()=>[i(j,{class:"loading-spinner"},{default:l((()=>[(o(),m(_,null,d(3,(e=>i(j,{class:"dot",key:e}))),64))])),_:1}),i(C,{class:"loading-text"},{default:l((()=>[u("加载中...")])),_:1})])),_:1})):v("",!0)])),_:1})}}},[["__scopeId","data-v-69de2c4a"]]);export{E as default};
